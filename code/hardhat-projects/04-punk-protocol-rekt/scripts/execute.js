
const hre = require("hardhat");
const Web3 = require('web3');
const ethers = require('ethers');

async function main() {

  await hre.run('compile');

  const myDummyAccount = "0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199";
  const _gas = 15000000;
  const _gasPrice = '30000000000000';
  const web3 = new Web3("http://127.0.0.1:8545/");


  const jsonAttackFile = require('../artifacts/contracts/Attacker.sol/Attack.json');
  const jsonAttackABI = jsonAttackFile.abi;
  var atkContract = new web3.eth.Contract(jsonAttackABI);
  atkContract.options.data = jsonAttackFile.bytecode;

  console.log("Starting...");

  await atkContract.deploy({ })
  .send({
      from: myDummyAccount, gas: _gas, gasPrice: _gasPrice
  }, function(error, transactionHash){ console.log(error, transactionHash); })
  .on('error', function(error){ console.log(error); })
  .then(function(newContractInstance){
      console.log("Atk Contract address: ", newContractInstance.options.address)
      atkContract.options.address = newContractInstance.options.address;
  });

  await atkContract.methods.checkBalance().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  await atkContract.methods.exploit_all().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  await atkContract.methods.checkBalance().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  console.log("Exitting...");
}


main();