
# Attack #11: Inverse Finance (2)

## Attack Classification

Oracle manipulation, Flash Loan assisted attack, resulted in money loss (>$1.2M)


## Attack Vector

Attacker used flash loans to manipulate the oracle used by Inverse Finance to calculate the share price of their collateral asset (yvCurve-3crypto token).
The oracle uses the asset balances in the crv3crypto LP directly in its calculation, thus the attacker was able to tilt the pool exchanging assets, causing the calculation to skyrocket.
This resulted in collateral being momentarily overvalued by Inverse, allowing the attacker to borrow more (DOLA tokens) than they should, which they later converted to stablecoins for profit.


The attack vector is described in more detail [here](https://twitter.com/peckshield/status/1537382891230883841) and [here](https://rekt.news/inverse-rekt2/).


### Brief Description

Inverse Finance uses an oracle to calculate the share price of the yvCurve-3crypto token.
The oracle uses the raw balances of the crv3crypto LP directly in its calculation (not considering decimals), multiplied by the asset/USD spot price and divided by a constant. 
The attacker performed a flash-loan assisted exchange in the crv3crypto LP swapping WBTC for USDT.
Since the USDT/USD spot price is close to 1 but the WBTC/USD price is in the order of 10000, an increment in WBTC followed by an equal ratio decrement of USDT will cause a spike in the price.
The fact that the oracle used the `uint256` raw balances meant that the value for WBTC (8 decimals) was more dominant than it should in the calculation compared to USDT (6 decimals).


The attacker deposited in the 3crypto pool obtaining crv3crypto tokens, which he later deposited in a Yearn vault to obtain the vulnerable yvCrv-3crypto, which he deposited to Inverse as collateral.
He then exchanged WBTC for USDT in the 3crypto LP, impacting the oracle's calculations, and went on to borrow an excessive amount of DOLA (Inverse's stablecoin) using the -now overpriced- collateral he deposited earlier. Converting DOLA to 3crv and then 3crv to USDT using the 3pool, he was able to walk away with 100K USDT and \~54 WBTC profit (around $1.2M).


### Vulnerable Code

View the full code on [Etherscan](https://etherscan.io/address/0xe8b3bc58774857732c6c1147bfc9b9e5fb6f427c#code).

Here we present the vulnerable oracle calculations. BTCFeed, ETHFeed and USDTFeed are the spot prices of the asset compared to USD and remain constant before and after manipulating the 3crypto LP. `crv3CryptoLPToken.totalSupply()` and `vault.pricePerShare()` also remain constant. Note that WBTC has 8 decimals wheras USDT has 6 decimals.

```solidity

    function latestAnswer() public view returns (uint256) {
        uint256 crvPoolBtcVal = WBTC.balanceOf(address(CRV3CRYPTO)) * uint256(BTCFeed.latestAnswer()) * 1e2;  // !! Manipulation of balanceOf (around x8 higher)
        uint256 crvPoolWethVal = WETH.balanceOf(address(CRV3CRYPTO)) * uint256(ETHFeed.latestAnswer()) / 1e8;
        uint256 crvPoolUsdtVal = USDT.balanceOf(address(CRV3CRYPTO)) * uint256(USDTFeed.latestAnswer()) * 1e4;  // !! Manipulation of balanceOf (around x8 lower)

        uint256 crvLPTokenPrice = (crvPoolBtcVal + crvPoolWethVal + crvPoolUsdtVal) * 1e18 / crv3CryptoLPToken.totalSupply();

        return (crvLPTokenPrice * vault.pricePerShare()) / 1e18;  // !! Manipulation resulted in x3 higher price
    }
```

### Attack Scheme

The vulnerability can be exploited in the following scenario, where A is the attacking contract:
1) A obtains WBTC (for example, via FL)
2) A deposits WBTC in Curve's 3crypto LP to obtain `crv3crypto` tokens.
3) A deposits `crv3crypto` to Yearn and obtains `yvCrv-3crypto` tokens.
4) A deposits `yvCrv-3crypto` to Inverse as collateral.
5) A exchanges WBTC for USDT in the 3crypto LP -- indirectly manipulating the Inverse oracle's price.
6) A borrows an excessive amount of DOLA from Inverse.
7) A exchanges DOLA for `3crv` tokens.
8) A exchanges `3crv` tokens for USDT, repays any FLs and walks away with profit in WBTC and USDT.

#### Mitigation

In order to prevent this attack, the oracle logic should be changed to not depend in the raw balances of the assets in the 3crypto pool.
If this needs to be the case, then some conversion to a common base asset should be made.

### Simulate the Attack

Inside `~/hardhat-projects/11-inverse-finance-2-rekt/` run:

Terminal #0:

```bash
$ npx hardhat node
```

Terminal #1:
```bash
$ node scripts/execute.js
```

We simulated [this transaction](https://etherscan.io/tx/0x958236266991bc3fe3b77feaacea120f172c0708ad01c7a715b255f218f9313c).

Finally, you should end up with around $100K USDT and 54 WBTC credited to the attacking contract in Terminal #0.